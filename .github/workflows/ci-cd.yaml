name: CI/CD Pipeline - FastAPI on GKE

on:
  push:
    branches: [ "main" ]

env:
  IMAGE_NAME: fastapi-app
  GAR_LOCATION: us-central1-docker.pkg.dev
  REPO_NAME: fastapi-repo

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      # 3. Install Dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Lint using flake8
      - name: Lint Code (Flake8)
        run: flake8 .

      # 5. Security Scan using Bandit
      - name: Security Scan (Bandit)
        run: bandit -r .

      # 6. Run Unit Tests
      - name: Run Unit Tests
        run: |
          export PYTHONPATH=.
          pytest tests/ --maxfail=1 --disable-warnings

      # 7. Trivy File System Scan
      - name: Trivy File System Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: 1
          format: 'table'

      # 8. Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 9. Configure Docker for Artifact Registry
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}

      # 10. Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t $GAR_LOCATION/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest .

      # 11. Scan Docker Image with Trivy
      - name: Trivy Docker Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.GAR_LOCATION }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          exit-code: 1
          format: 'table'

      # 12. Push Image to GAR
      - name: Push Image to Artifact Registry
        run: |
          docker push $GAR_LOCATION/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

      # 13. Connect to GKE
      - name: Connect to GKE
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE }}

      # 14. Deploy to GKE
      - name: Deploy to GKE
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml

      # 15. Notify Team via Slack Webhook
      - name: Notify via Slack
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: workflow,job,commit,repo
          custom_payload: |
            {
              "text": "âœ… CI/CD Success: FastAPI app deployed to GKE successfully!"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
